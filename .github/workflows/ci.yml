name: CI

on:
  pull_request:
  merge_group:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        id: install
        run: pip install -r requirements.txt

      - name: Lint with ruff
        id: lint
        run: ruff check .

      - name: Run tests
        id: test
        run: pytest tests/ -v

      - name: Comment on PR with failure details
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const steps = {
              install: '${{ steps.install.outcome }}',
              lint: '${{ steps.lint.outcome }}',
              test: '${{ steps.test.outcome }}'
            };
            
            const failedSteps = Object.entries(steps)
              .filter(([_, outcome]) => outcome === 'failure')
              .map(([step, _]) => step);
            
            const isMergeGroup = context.eventName === 'merge_group';
            const eventType = isMergeGroup ? 'Merge Queue' : 'PR';
            
            let comment = `## ❌ CI Workflow Failed${isMergeGroup ? ' in Merge Queue' : ''}\n\n`;
            comment += `**Failed step(s):** ${failedSteps.join(', ')}\n\n`;
            comment += '### Failure Details:\n\n';
            
            if (steps.install === 'failure') {
              comment += '- **Install dependencies** - Failed to install Python dependencies\n';
            }
            if (steps.lint === 'failure') {
              comment += '- **Lint with ruff** - Code linting failed. Run `ruff check .` locally to see issues\n';
            }
            if (steps.test === 'failure') {
              comment += '- **Run tests** - Tests failed. Run `pytest tests/ -v` locally to see failures\n';
            }
            
            if (isMergeGroup) {
              comment += '\n**Note:** This failure occurred when testing your PR in combination with other PRs in the merge queue. ';
              comment += 'This indicates a semantic conflict — your changes may be incompatible with other merged changes.\n';
            }
            
            comment += `\n**Workflow run:** ${context.payload.repository.html_url}/actions/runs/${context.runId}\n`;
            
            // For pull_request events, comment on the PR
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
            
            // For merge_group events, find and comment on the PR associated with the merge group
            if (isMergeGroup) {
              // Extract PR number from the merge group head ref
              // Format: refs/heads/gh-readonly-queue/{base_branch}/pr-{number}-{sha}
              const headRef = context.payload.merge_group.head_ref;
              const prMatch = headRef.match(/pr-(\d+)-/);
              
              if (prMatch) {
                const prNumber = parseInt(prMatch[1]);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: comment
                });
              } else {
                console.error(`Could not extract PR number from merge group head_ref: ${headRef}`);
              }
            }
